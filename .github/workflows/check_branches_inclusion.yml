name: Check Branches Inclusion (reusable)

on:
  workflow_call:
    inputs:
      including_branch:
        required: true
        type: string
      included_branch:
        required: true
        type: string
      create_pr:
        required: false
        type: boolean
        default: true
      auto_merge:
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  check-inclusion:
    runs-on: ubuntu-latest
    outputs:
      aligned: ${{ steps.check-inclusion.outputs.aligned }}
      behind-by: ${{ steps.check-inclusion.outputs['behind-by'] }}
      pr_exists: ${{ steps.consolidate-sync-pr.outputs.pr-exists }}
      pr_number: ${{ steps.consolidate-sync-pr.outputs['pr-number'] }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check inclusion
        id: check-inclusion
        shell: bash
        run: |
          set -euo pipefail
          INCLUDING=${{ inputs.including_branch }}
          INCLUDED=${{ inputs.included_branch }}

          git fetch origin "$INCLUDING"
          git fetch origin "$INCLUDED"

          INCLUDED_LATEST=$(git rev-parse remotes/origin/"$INCLUDED")

          if git merge-base --is-ancestor "$INCLUDED_LATEST" remotes/origin/"$INCLUDING"; then
            echo "aligned=true" >> $GITHUB_OUTPUT
            echo "COMPARE_ALIGNED=true" >> $GITHUB_ENV
            echo "behind-by=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          BASE=$(git merge-base remotes/origin/"$INCLUDING" remotes/origin/"$INCLUDED")
          BEHIND=$(git rev-list --count "$BASE"..remotes/origin/"$INCLUDED")
          echo "aligned=false" >> $GITHUB_OUTPUT
          echo "COMPARE_ALIGNED=false" >> $GITHUB_ENV
          echo "behind-by=$BEHIND" >> $GITHUB_OUTPUT

      - name: Merge included branch into including branch if required
        id: merge-included-into-including
        if: ${{ inputs.auto_merge == true && env.COMPARE_ALIGNED == 'false' }}
        shell: bash
        run: |
          set -euo pipefail
          INCLUDING=${{ inputs.including_branch }}
          INCLUDED=${{ inputs.included_branch }}

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin "$INCLUDING"
          git checkout -B "$INCLUDING" origin/"$INCLUDING"
          git merge --no-ff --no-edit remotes/origin/"$INCLUDED"
          git push origin "$INCLUDING"

      - name: Check for existing sync PR
        id: check-sync-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.github_token }}
          script: |
            const including = process.env.INCLUDING_BRANCH;
            const included = process.env.INCLUDED_BRANCH;
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${included}`,
              base: including,
              state: 'open'
            });
            if (prs.data.length > 0) {
              core.setOutput('exists', 'true');
              core.setOutput('pr-number', String(prs.data[0].number));
              core.setOutput('created', 'false');
            } else {
              core.setOutput('exists', 'false');
            }
        env:
          INCLUDING_BRANCH: ${{ inputs.including_branch }}
          INCLUDED_BRANCH: ${{ inputs.included_branch }}

      - name: Create sync PR if needed
        id: create-sync-pr
        if: ${{ inputs.create_pr == true && steps.check-sync-pr.outputs.exists == 'false' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.github_token }}
          script: |
            const including = process.env.INCLUDING_BRANCH;
            const included = process.env.INCLUDED_BRANCH;
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”„ Sync including branch with included branch',
              head: included,
              base: including,
              body: `Automated sync: update ${including} with ${included}`
            });
            core.setOutput('created', 'true');
            core.setOutput('pr-number', String(pr.data.number));
            core.setOutput('exists', 'true');
        env:
          INCLUDING_BRANCH: ${{ inputs.including_branch }}
          INCLUDED_BRANCH: ${{ inputs.included_branch }}

      - name: Auto-merge sync PR when requested
        id: auto-merge-sync-pr
        if: ${{ inputs.auto_merge == true && (steps.check-sync-pr.outputs.exists == 'true' || steps.create-sync-pr.outputs.created == 'true') }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.github_token }}
          script: |
            const createdPrNumber = process.env.CREATED_PR_NUMBER || '';
            const existingPrNumber = process.env.EXISTING_PR_NUMBER || '';
            const prNumber = createdPrNumber || existingPrNumber;
            if (!prNumber) return;
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: Number(prNumber),
                merge_method: 'merge'
              });
            } catch (e) {
              core.setFailed(`Auto-merge failed for PR #${prNumber}: ${e.message}`);
            }
        env:
          CREATED_PR_NUMBER: ${{ steps.create-sync-pr.outputs['pr-number'] }}
          EXISTING_PR_NUMBER: ${{ steps.check-sync-pr.outputs['pr-number'] }}
          INCLUDING_BRANCH: ${{ inputs.including_branch }}
          INCLUDED_BRANCH: ${{ inputs.included_branch }}

      - name: Consolidate PR outputs
        id: consolidate-sync-pr
        shell: bash
        run: |
          CHECK_EXISTS="${{ steps.check-sync-pr.outputs.exists }}"
          CHECK_PR_NUMBER="${{ steps.check-sync-pr.outputs['pr-number'] }}"
          CREATED_EXISTS="${{ steps.create-sync-pr.outputs.exists }}"
          CREATED_PR_NUMBER="${{ steps.create-sync-pr.outputs['pr-number'] }}"
          PR_EXISTS="false"
          if [ "${CREATED_EXISTS}" = "true" ] || [ "${CHECK_EXISTS}" = "true" ]; then PR_EXISTS="true"; fi
          PR_NUMBER="${CREATED_PR_NUMBER}"
          if [ -z "${PR_NUMBER}" ]; then PR_NUMBER="${CHECK_PR_NUMBER}"; fi
          echo "pr-exists=${PR_EXISTS}" >> $GITHUB_OUTPUT
          echo "pr-number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "aligned=${{ steps.check-inclusion.outputs.aligned }}" >> $GITHUB_OUTPUT
          echo "behind-by=${{ steps.check-inclusion.outputs['behind-by'] }}" >> $GITHUB_OUTPUT
