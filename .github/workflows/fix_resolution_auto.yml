# .github/workflows/02-fix-resolution-auto.yml
name: Fix Resolution - Automated

on:
  create:
    branches:
      - fix-codeql-alert-[0-9]+
  issues:
    types: [opened]

permissions:
  contents: write
  security-events: write
  issues: write
  pull-requests: write

jobs:
  check-if-codeql-issue:
    name: Check if CodeQL Issue
    runs-on: ubuntu-latest
    outputs:
      is-codeql: ${{ steps.check.outputs.is-codeql }}
      alert-id: ${{ steps.check.outputs.alert-id }}
      branch-name: ${{ steps.check.outputs.branch-name }}
      issue-number: ${{ steps.check.outputs.issue-number }}
    
    steps:
      - name: Check issue labels or branch
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            let issue_number = null;
            let branch_name = null;
            
            // Handle different trigger types
            if (context.eventName === 'issues') {
              // Triggered by issue creation
              issue_number = context.payload.issue.number;
            } else if (context.eventName === 'create') {
              // Triggered by branch creation - extract alert ID from branch name
              branch_name = context.payload.ref.replace('refs/heads/', '');
              const branchMatch = branch_name.match(/^fix-codeql-alert-(\d+)$/);
              
              if (!branchMatch) {
                console.log(`Branch ${branch_name} does not match pattern fix-codeql-alert-*. Skipping.`);
                core.setOutput('is-codeql', false);
                return;
              }
              
              // Find the issue by searching for issues with this branch name
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'codeql'
              });
              
              // Find issue that mentions this branch
              const matchingIssue = issues.data.find(issue => 
                issue.body && issue.body.includes(`\`${branch_name}\``)
              );
              
              if (matchingIssue) {
                issue_number = matchingIssue.number;
              } else {
                console.log(`No CodeQL issue found for branch ${branch_name}. Skipping.`);
                core.setOutput('is-codeql', false);
                return;
              }
            }
            
            if (!issue_number) {
              core.setOutput('is-codeql', false);
              return;
            }
            
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number
            });

            const isCodeQL = issue.data.labels.some(l => l.name === 'codeql');
            core.setOutput('is-codeql', isCodeQL);
            core.setOutput('issue-number', issue_number);

            if (isCodeQL) {
              // Extract alert ID from issue body
              const alertMatch = issue.data.body.match(/\*\*Alert ID:\*\* (\d+)/);
              
              if (!alertMatch) {
                core.setFailed(`Could not find Alert ID in issue #${issue_number} body. Expected format: **Alert ID:** <number>`);
                return;
              }
              
              core.setOutput('alert-id', alertMatch[1]);
              
              // Use branch name from create event if available, otherwise extract from issue body
              if (branch_name) {
                core.setOutput('branch-name', branch_name);
              } else {
                const branchMatch = issue.data.body.match(/\*\*Fix Branch:\*\* `([^`]+)`/);
                if (!branchMatch) {
                  core.setFailed(`Could not find Fix Branch in issue #${issue_number} body. Expected format: **Fix Branch:** \`<branch-name>\``);
                  return;
                }
                core.setOutput('branch-name', branchMatch[1]);
              }
            }

  attempt-auto-fix:
    name: Attempt Automated Fix
    needs: check-if-codeql-issue
    if: needs.check-if-codeql-issue.outputs.is-codeql == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout fix branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-if-codeql-issue.outputs.branch-name }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Attempt automated fix with CodeQL
        id: auto-fix
        uses: github/codeql-action/autofix@v3
        continue-on-error: true
        with:
          alert-id: ${{ needs.check-if-codeql-issue.outputs.alert-id }}

      - name: Commit and push fixes
        if: steps.auto-fix.outcome == 'success'
        run: |
          git config user.name "addventa-github-actions[bot]"
          git config user.email "addventa-github-actions[bot]@addventa.com"
          
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "fix: automated CodeQL fix for alert #${{ needs.check-if-codeql-issue.outputs.alert-id }}"
            git push origin ${{ needs.check-if-codeql-issue.outputs.branch-name }}
          else
            echo "No changes to commit"
          fi

      - name: Verify fix with CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Analyze
        uses: github/codeql-action/analyze@v3

      - name: Check if alert resolved
        id: check-resolved
        uses: actions/github-script@v7
        with:
          script: |
            const alertId = ${{ needs.check-if-codeql-issue.outputs.alert-id }};
            
            try {
              const alert = await github.rest.codeScanning.getAlert({
                owner: context.repo.owner,
                repo: context.repo.repo,
                alert_number: alertId
              });
              
              const resolved = alert.data.state === 'fixed' || alert.data.state === 'dismissed';
              core.setOutput('resolved', resolved);
              
              if (!resolved) {
                core.setFailed('Vulnerability still present after fix attempt');
              }
            } catch (error) {
              console.log('Alert not found, may be resolved');
              core.setOutput('resolved', true);
            }

      - name: Mark issue as pending if resolved
        if: steps.check-resolved.outputs.resolved == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.payload.issue.number;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: '✅ Vulnerability automatically fixed and verified. Fix is pending release.'
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              labels: ['security', 'codeql', 'automated-fix', 'pending']
            });
            
            console.log(`Updated issue #${issue_number} to pending status`);

      - name: Alert if not resolved
        if: steps.check-resolved.outputs.resolved != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = ${{ needs.check-if-codeql-issue.outputs.issue-number }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: '⚠️ Automated fix attempt completed but vulnerability still present. Manual intervention required.'
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              labels: ['needs-manual-fix']
            });
