# .github/workflows/02-fix-resolution-auto.yml
name: Fix Resolution - Automated

on:
  create:
    branches:
      - fix-codeql-alert-[0-9]+

permissions:
  contents: write
  security-events: write
  issues: write
  pull-requests: write

jobs:
  check-if-codeql-issue:
    name: Check if CodeQL Issue
    runs-on: ubuntu-latest
    outputs:
      is-codeql: ${{ steps.check.outputs.is-codeql }}
      alert-id: ${{ steps.check.outputs.alert-id }}
      branch-name: ${{ steps.check.outputs.branch-name }}
      issue-number: ${{ steps.check.outputs.issue-number }}
    
    steps:
      - name: Extract and Validate Branch Name
        id: extract-branch
        uses: actions/github-script@v7
        with:
          script: |
            // Extract branch name from create event
            const branch_name = context.payload.ref.replace('refs/heads/', '');
            const branchMatch = branch_name.match(/^fix-codeql-alert-(\d+)$/);
            
            if (!branchMatch) {
              console.log(`Branch ${branch_name} does not match pattern fix-codeql-alert-*. Skipping.`);
              const fs = require('fs');
              fs.writeFileSync('branch_info.json', JSON.stringify({
                isValid: false,
                branchName: branch_name
              }), 'utf8');
              return;
            }
            
            console.log(`Valid branch name: ${branch_name}`);
            
            // Write branch info to file
            const fs = require('fs');
            fs.writeFileSync('branch_info.json', JSON.stringify({
              isValid: true,
              branchName: branch_name,
              alertId: branchMatch[1]
            }), 'utf8');

      - name: Find Related Issue
        id: find-issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read branch info
            let branchInfo;
            try {
              branchInfo = JSON.parse(fs.readFileSync('branch_info.json', 'utf8'));
            } catch (error) {
              console.log('Could not read branch info:', error.message);
              return;
            }
            
            if (!branchInfo.isValid) {
              console.log('Branch is not valid, skipping issue search');
              return;
            }
            
            const branch_name = branchInfo.branchName;
            
            console.log(`Searching for issue related to branch: ${branch_name}`);
            
            // Find the issue by searching for issues with this branch name
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'codeql'
            });
            
            // Find issue that mentions this branch
            const matchingIssue = issues.data.find(issue => 
              issue.body && issue.body.includes(`\`${branch_name}\``)
            );
            
            let issue_number = null;
            
            if (matchingIssue) {
              issue_number = matchingIssue.number;
              console.log(`Found issue #${issue_number} for branch ${branch_name}`);
            } else {
              console.log(`No CodeQL issue found for branch ${branch_name}. Skipping.`);
            }
            
            // Write issue info to file
            fs.writeFileSync('issue_info.json', JSON.stringify({
              issueNumber: issue_number,
              branchName: branch_name
            }), 'utf8');

      - name: Get Issue Details and Check CodeQL Label
        id: check-codeql
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read issue info
            let issueInfo;
            try {
              issueInfo = JSON.parse(fs.readFileSync('issue_info.json', 'utf8'));
            } catch (error) {
              console.log('Could not read issue info:', error.message);
              return;
            }
            
            const issue_number = issueInfo.issueNumber;
            
            if (!issue_number) {
              console.log('No issue number found, skipping');
              return;
            }
            
            console.log(`Fetching details for issue #${issue_number}...`);
            
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number
            });

            const isCodeQL = issue.data.labels.some(l => l.name === 'codeql');
            
            console.log(`Issue #${issue_number} is CodeQL: ${isCodeQL}`);
            
            // Write issue details to file
            fs.writeFileSync('issue_details.json', JSON.stringify({
              issueNumber: issue_number,
              isCodeQL: isCodeQL,
              issueBody: issue.data.body,
              labels: issue.data.labels.map(l => l.name)
            }), 'utf8');

      - name: Extract Alert ID from Issue
        id: extract-alert-id
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read issue details
            let issueDetails;
            try {
              issueDetails = JSON.parse(fs.readFileSync('issue_details.json', 'utf8'));
            } catch (error) {
              console.log('Could not read issue details:', error.message);
              return;
            }
            
            if (!issueDetails.isCodeQL) {
              console.log('Issue is not a CodeQL issue, skipping alert ID extraction');
              return;
            }
            
            const issue_number = issueDetails.issueNumber;
            const issue_body = issueDetails.issueBody || '';
            
            // Extract alert ID from issue body
            const alertMatch = issue_body.match(/\*\*Alert ID:\*\* (\d+)/);
            
            if (!alertMatch) {
              core.setFailed(`Could not find Alert ID in issue #${issue_number} body. Expected format: **Alert ID:** <number>`);
              return;
            }
            
            const alert_id = alertMatch[1];
            console.log(`Extracted Alert ID: ${alert_id}`);
            
            // Write alert info to file
            fs.writeFileSync('alert_info.json', JSON.stringify({
              alertId: alert_id,
              issueNumber: issue_number
            }), 'utf8');

      - name: Set Branch Name
        id: set-branch-name
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read branch info
            let branchInfo;
            try {
              branchInfo = JSON.parse(fs.readFileSync('branch_info.json', 'utf8'));
            } catch (error) {
              console.log('Could not read branch info:', error.message);
              return;
            }
            
            // Use branch name from create event (already available)
            const branch_name = branchInfo.branchName;
            
            console.log(`Using branch name: ${branch_name}`);
            
            // Write final branch name to file
            fs.writeFileSync('final_branch_info.json', JSON.stringify({
              branchName: branch_name
            }), 'utf8');

      - name: Set Final Outputs
        id: check
        run: |
          # Read all info files and set outputs
          
          # Check if branch is valid
          if [ -f "branch_info.json" ]; then
            IS_VALID=$(node -p "require('./branch_info.json').isValid || false")
            if [ "$IS_VALID" != "true" ]; then
              echo "is-codeql=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            echo "is-codeql=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Read issue details
          if [ -f "issue_details.json" ]; then
            IS_CODEQL=$(node -p "require('./issue_details.json').isCodeQL || false")
            ISSUE_NUMBER=$(node -p "require('./issue_details.json').issueNumber || ''")
            
            echo "is-codeql=${IS_CODEQL}" >> $GITHUB_OUTPUT
            echo "issue-number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
          else
            echo "is-codeql=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Read alert ID
          if [ -f "alert_info.json" ]; then
            ALERT_ID=$(node -p "require('./alert_info.json').alertId || ''")
            echo "alert-id=${ALERT_ID}" >> $GITHUB_OUTPUT
          else
            echo "alert-id=" >> $GITHUB_OUTPUT
          fi
          
          # Read branch name
          if [ -f "final_branch_info.json" ]; then
            BRANCH_NAME=$(node -p "require('./final_branch_info.json').branchName || ''")
            echo "branch-name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          else
            # Fallback to branch_info.json
            if [ -f "branch_info.json" ]; then
              BRANCH_NAME=$(node -p "require('./branch_info.json').branchName || ''")
              echo "branch-name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
            else
              echo "branch-name=" >> $GITHUB_OUTPUT
            fi
          fi
        shell: bash

  attempt-auto-fix:
    name: Attempt Automated Fix
    needs: check-if-codeql-issue
    if: needs.check-if-codeql-issue.outputs.is-codeql == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout fix branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-if-codeql-issue.outputs.branch-name }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Attempt automated fix with CodeQL
        id: auto-fix
        uses: github/codeql-action/autofix@v3
        continue-on-error: true
        with:
          alert-id: ${{ needs.check-if-codeql-issue.outputs.alert-id }}

      - name: Commit and push fixes
        if: steps.auto-fix.outcome == 'success'
        run: |
          git config user.name "addventa-github-actions[bot]"
          git config user.email "addventa-github-actions[bot]@addventa.com"
          
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "fix: automated CodeQL fix for alert #${{ needs.check-if-codeql-issue.outputs.alert-id }}"
            git push origin ${{ needs.check-if-codeql-issue.outputs.branch-name }}
          else
            echo "No changes to commit"
          fi

      - name: Verify fix with CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Analyze
        uses: github/codeql-action/analyze@v3

      - name: Check if alert resolved
        id: check-resolved
        uses: actions/github-script@v7
        with:
          script: |
            const alertId = ${{ needs.check-if-codeql-issue.outputs.alert-id }};
            
            try {
              const alert = await github.rest.codeScanning.getAlert({
                owner: context.repo.owner,
                repo: context.repo.repo,
                alert_number: alertId
              });
              
              const resolved = alert.data.state === 'fixed' || alert.data.state === 'dismissed';
              core.setOutput('resolved', resolved);
              
              if (!resolved) {
                core.setFailed('Vulnerability still present after fix attempt');
              }
            } catch (error) {
              console.log('Alert not found, may be resolved');
              core.setOutput('resolved', true);
            }

      - name: Mark issue as pending if resolved
        if: steps.check-resolved.outputs.resolved == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.payload.issue.number;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: '✅ Vulnerability automatically fixed and verified. Fix is pending release.'
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              labels: ['security', 'codeql', 'automated-fix', 'pending']
            });
            
            console.log(`Updated issue #${issue_number} to pending status`);

      - name: Alert if not resolved
        if: steps.check-resolved.outputs.resolved != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = ${{ needs.check-if-codeql-issue.outputs.issue-number }};
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: '⚠️ Automated fix attempt completed but vulnerability still present. Manual intervention required.'
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              labels: ['needs-manual-fix']
            });
