
name: "CodeQL Branch Scan (reusable)"

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
        description: 'Branch name to scan'
      severity:
        required: false
        type: string
        description: 'Severity filter - affects which query packs are used (high/critical = security-extended, all = security-and-quality)'
        default: 'high,critical'

jobs:
  analyze:
    name: Analyze (javascript-typescript)
    # Runner size impacts CodeQL analysis time. To learn more, please see:
    #   - https://gh.io/recommended-hardware-resources-for-running-codeql
    #   - https://gh.io/supported-runners-and-hardware-resources
    #   - https://gh.io/using-larger-runners (GitHub.com only)
    # Consider using larger runners or machines with greater resources for possible analysis time improvements.
    runs-on: ubuntu-latest
    permissions:
      # required for all workflows
      security-events: write

      # required to fetch internal or private CodeQL packs
      packages: read

      # only required for workflows in private repositories
      actions: read
      contents: read
        # CodeQL supports the following values keywords for 'language': 'actions', 'c-cpp', 'csharp', 'go', 'java-kotlin', 'javascript-typescript', 'python', 'ruby', 'rust', 'swift'
        # Use `c-cpp` to analyze code written in C, C++ or both
        # Use 'java-kotlin' to analyze code written in Java, Kotlin or both
        # Use 'javascript-typescript' to analyze code written in JavaScript, TypeScript or both
        # To learn more about changing the languages that are analyzed or customizing the build mode for your analysis,
        # see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/customizing-your-advanced-setup-for-code-scanning.
        # If you are analyzing a compiled language, you can modify the 'build-mode' for that language to customize how
        # your codebase is analyzed, see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/codeql-code-scanning-for-compiled-languages
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch }}

    # Determine which query pack to use based on severity filter
    # This speeds up analysis by running fewer queries for high/critical severity scans
    - name: Determine Query Pack
      id: query-pack
      run: |
        SEVERITY="${{ inputs.severity }}"
        if [[ "$SEVERITY" == "high,critical" ]] || [[ "$SEVERITY" == "critical" ]] || [[ "$SEVERITY" == "high" ]]; then
          # Use security-extended for high/critical - faster, focuses on security issues
          QUERY_PACK="security-extended"
          echo "Using security-extended query pack (faster, security-focused)"
        else
          # Use security-and-quality for all severities - more comprehensive
          QUERY_PACK="security-and-quality"
          echo "Using security-and-quality query pack (comprehensive)"
        fi
        echo "query-pack=$QUERY_PACK" >> $GITHUB_OUTPUT

    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: javascript-typescript
        build-mode: none
        config-file: ./.github/codeql/codeql-config.yml
        # Use query packs based on severity filter to speed up analysis
        # security-extended: Faster, focuses on security issues (typically high/critical severity)
        # security-and-quality: Slower, includes quality issues (all severities)
        queries: ${{ steps.query-pack.outputs.query-pack }}

    # If the analyze step fails for one of the languages you are analyzing with
    # "We were unable to automatically build your code", modify the matrix above
    # to set the build mode to "manual" for that language. Then modify this step
    # to build your code.
    # â„¹ï¸ Command-line programs to run using the OS shell.
    # ðŸ“š See https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepsrun
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:javascript-typescript"
        wait-for-processing: true

    - name: Log Found Alerts
      id: log-found-alerts
      if: 1
      uses: actions/github-script@v7
      with:
        script: |
          const branchRef = `refs/heads/${{ inputs.branch }}`;
          const severityInput = '${{ inputs.severity }}';
          
          // Parse severity levels (support comma-separated values)
          const severityLevels = severityInput.split(',').map(s => s.trim().toLowerCase());
          console.log(`Scanning for severities: ${severityLevels.join(', ')} on branch ${{ inputs.branch }}`);
          
          // Fetch alerts for each severity level in parallel
          const alertPromises = severityLevels.map(severity =>
            github.rest.codeScanning.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              severity: severity,
              ref: branchRef,
              per_page: 100
            })
          );
          
          const alertResponses = await Promise.all(alertPromises);
          
          // Combine all alerts from different severity levels
          const allImportantAlerts = alertResponses.flatMap(response => response.data || []);
          
          // Deduplicate alerts by alert number
          const uniqueAlerts = Array.from(
            new Map(allImportantAlerts.map(alert => [alert.number, alert])).values()
          );
          
          console.log(`Found ${uniqueAlerts.length} opened ${severityInput} alerts on branch ${{ inputs.branch }}`);
          
          // Store alerts for subsequent steps
          core.setOutput('alerts', JSON.stringify(uniqueAlerts));