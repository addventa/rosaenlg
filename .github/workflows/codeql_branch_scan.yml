
name: "CodeQL Branch Scan (reusable)"

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
        description: 'Branch name to scan'
      severity:
        required: false
        type: string
        description: 'Severity filter - affects which query packs are used (high/critical = security-extended, all = security-and-quality)'
        default: 'high,critical'
      query-id:
        required: false
        type: string
        description: 'Specific CodeQL query/rule ID to scan (e.g., javascript/example/rule-name). If provided, only this query will be run.'
        default: ''

jobs:
  analyze:
    name: Analyze (javascript-typescript)
    # Runner size impacts CodeQL analysis time. To learn more, please see:
    #   - https://gh.io/recommended-hardware-resources-for-running-codeql
    #   - https://gh.io/supported-runners-and-hardware-resources
    #   - https://gh.io/using-larger-runners (GitHub.com only)
    # Consider using larger runners or machines with greater resources for possible analysis time improvements.
    runs-on: ubuntu-latest
    permissions:
      # required for all workflows (write includes read)
      security-events: write

      # required to fetch internal or private CodeQL packs
      packages: read

      # only required for workflows in private repositories
      actions: read
      contents: read
        # CodeQL supports the following values keywords for 'language': 'actions', 'c-cpp', 'csharp', 'go', 'java-kotlin', 'javascript-typescript', 'python', 'ruby', 'rust', 'swift'
        # Use `c-cpp` to analyze code written in C, C++ or both
        # Use 'java-kotlin' to analyze code written in Java, Kotlin or both
        # Use 'javascript-typescript' to analyze code written in JavaScript, TypeScript or both
        # To learn more about changing the languages that are analyzed or customizing the build mode for your analysis,
        # see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/customizing-your-advanced-setup-for-code-scanning.
        # If you are analyzing a compiled language, you can modify the 'build-mode' for that language to customize how
        # your codebase is analyzed, see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/codeql-code-scanning-for-compiled-languages
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.branch }}

    # Determine which query pack to use based on severity filter
    # This speeds up analysis by running fewer queries for high/critical severity scans
    - name: Determine Query Pack
      id: query-pack
      run: |
        SEVERITY="${{ inputs.severity }}"
        if [[ "$SEVERITY" == "high,critical" ]] || [[ "$SEVERITY" == "critical" ]] || [[ "$SEVERITY" == "high" ]]; then
          # Use security-extended for high/critical - faster, focuses on security issues
          QUERY_PACK="security-extended"
          echo "Using security-extended query pack (faster, security-focused)"
        else
          # Use security-and-quality for all severities - more comprehensive
          QUERY_PACK="security-and-quality"
          echo "Using security-and-quality query pack (comprehensive)"
        fi
        echo "query-pack=$QUERY_PACK" >> $GITHUB_OUTPUT

    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: javascript-typescript
        build-mode: none
        config-file: ./.github/codeql/codeql-config.yml

    # If the analyze step fails for one of the languages you are analyzing with
    # "We were unable to automatically build your code", modify the matrix above
    # to set the build mode to "manual" for that language. Then modify this step
    # to build your code.
    # ‚ÑπÔ∏è Command-line programs to run using the OS shell.
    # üìö See https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepsrun
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "/language:javascript-typescript"
        wait-for-processing: true

    - name: Log Found Alerts
      uses: ./.github/actions/log_codeql_alerts
      with:
        branch: ${{ inputs.branch }}
        severity: ${{ inputs.severity }}
