# .github/workflows/03-fix-resolution-manual.yml
name: Fix Resolution - Manual Verification

on:
  push:
    branches:
      - 'fix-codeql-alert-[0-9]+'

permissions:
  contents: write
  security-events: write
  issues: write
  pull-requests: write
  actions: read
  packages: read

jobs:
  get-query-info:
    name: Get Query Info
    runs-on: ubuntu-latest
    permissions:
      security-events: read
    outputs:
      branch-name: ${{ steps.get-info.outputs.branch-name }}
      query-id: ${{ steps.get-info.outputs.query-id }}
      alert-id: ${{ steps.get-info.outputs.alert-id }}
    steps:
      - name: Extract alert ID and get query ID
        id: get-info
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = context.ref.replace('refs/heads/', '');
            const alertId = parseInt(branchName.replace('fix-codeql-alert-', ''));
            
            // Get query ID from alert
            const alert = await github.rest.codeScanning.getAlert({
              owner: context.repo.owner,
              repo: context.repo.repo,
              alert_number: alertId
            });
            
            const queryId = alert.data.rule?.id || '';
            console.log(`Found query ID: ${queryId}`);
            console.log(`Found alert ID: ${alertId}`);
            
            core.setOutput('branch-name', branchName);
            core.setOutput('query-id', queryId);
            core.setOutput('alert-id', alertId.toString());

  codeql-analysis:
    name: Run CodeQL Analysis
    needs: get-query-info
    uses: ./.github/workflows/codeql_branch_analysis.yml
    with:
      branch: ${{ needs.get-query-info.outputs.branch-name }}
      severity: 'high,critical'
      query-id: ${{ needs.get-query-info.outputs.query-id }}

  verify-fix:
    name: Verify Manual Fix
    needs: [ codeql-analysis, get-query-info]
    runs-on: ubuntu-latest
    permissions:
      security-events: read
    outputs:
      resolved: ${{ steps.check-resolved.outputs.resolved }}
      branch-name: ${{ needs.get-query-info.outputs.branch-name }}
    
    steps:

      - name: Download CodeQL Analysis Results
        uses: actions/download-artifact@v4
        with:
          name: codeql-analysis-results
          path: codeql-results

      - name: Check if vulnerability resolved
        id: check-resolved
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const alertId = ${{ needs.get-query-info.outputs.alert-id }};
            const queryId = '${{ needs.get-query-info.outputs.query-id }}';
            let resolved = false;
            
            // Read CodeQL analysis results from downloaded artifacts
            const resultsPath = path.join(process.cwd(), 'codeql-results', 'codeql-results.json');
            
            try {
              const analysisResults = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
              const totalResults = analysisResults.summary?.totalResults || 0;
              
              console.log(`CodeQL analysis found ${totalResults} results`);
              
              // If no results found, vulnerability is resolved
              if (totalResults === 0) {
                resolved = true;
                console.log('No vulnerabilities found in analysis - vulnerability is resolved');
              } else if (queryId && analysisResults.results) {
                // Check if the specific query/rule is still present
                const matchingResults = analysisResults.results.filter(r => 
                  r.ruleId === queryId || r.ruleId.includes(queryId)
                );
                
                console.log(`Found ${matchingResults.length} results matching query ${queryId}`);
                resolved = matchingResults.length === 0;
                
                if (resolved) {
                  console.log('No matching results found - vulnerability is resolved');
                } else {
                  console.log('Matching results found - vulnerability still present');
                }
              } else {
                // If we can't match by query ID, check if any results exist
                resolved = totalResults === 0;
              }
            } catch (error) {
              console.log('Could not read analysis results, falling back to API check:', error.message);
              
              // Fallback to API check
              const alert = await github.rest.codeScanning.getAlert({
                owner: context.repo.owner,
                repo: context.repo.repo,
                alert_number: alertId
              });
              
              resolved = alert.data.state === 'fixed' || alert.data.state === 'dismissed';
              console.log(`API check: vulnerability resolved = ${resolved}`);
            }
            
            core.setOutput('resolved', resolved);
            console.log(`Final result: vulnerability resolved = ${resolved}`);
            
      - name: Alert if still vulnerable
        if: steps.check-resolved.outputs.resolved != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ needs.get-query-info.outputs.branch-name }}';
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'codeql'
            });

            for (const issue of issues.data) {
              if (issue.body && issue.body.includes(`\`${branchName}\``)) {
                const issueBody = [
                  '⚠️ Changes pushed but vulnerability still present. Please review the fix.',
                  '',
                  `Commit: ${context.sha}`
                ];

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: issueBody.join('\n')
                });
                break;
              }
            }
            
            core.setFailed('Vulnerability still present after manual fix');

  build-and-test:
    name: Build and Test
    needs: verify-fix
    if: needs.verify-fix.outputs.resolved == 'true'
    uses: ./.github/workflows/build_and_test.yml
    with:
      node-version: '20'
      fetch-depth: '0'

  find-and-close-issue:
    name: Find and Close Related Issue
    needs: [verify-fix, build-and-test]
    if: needs.verify-fix.outputs.resolved == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Find and close related issue
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ needs.verify-fix.outputs.branch-name }}';
            
            // Rechercher l'issue liée
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'codeql'
            });

            for (const issue of issues.data) {
              if (issue.body && issue.body.includes(`\`${branchName}\``)) {
              
                const issueBody = [
                  '✅ Manual fix verified successfully. Vulnerability resolved. Fix is pending release.',
                  '',
                  `Commit: ${context.sha}`
                ].join('\n');

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: issueBody.join('\n')
                });

                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['security', 'codeql', 'manual-fix', 'pending']
                });

                console.log(`Updated issue #${issue.number} to pending status`);
                break;
              }
            }