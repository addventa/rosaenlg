name: 'Check CodeQL Alert Status'
description: 'Verify whether a specific CodeQL alert still exists and report its status'

inputs:
  branch:
    description: 'Branch to check (with or without refs/heads/)'
    required: true
  alert-id:
    description: 'Numeric CodeQL alert identifier'
    required: true
  fail-on-missing:
    description: 'If true, fail when the alert cannot be found'
    required: false
    default: true

outputs:
  exists:
    description: 'true if the alert still exists in the repository'
  state:
    description: 'Current alert state (open, fixed, dismissed, etc.)'
    
runs:
  using: 'composite'
  steps:
    - name: Check alert status
      uses: actions/github-script@v7
      id: check-alert
      with:
        script: |
          const failOnMissing = '${{ inputs['fail-on-missing'] }}' === 'true';
          const alertId = parseInt('${{ inputs['alert-id'] }}', 10);
          const rawBranch = '${{ inputs.branch }}'.trim();
          const branchRef = rawBranch.startsWith('refs/') ? rawBranch : `refs/heads/${rawBranch}`;
          
          if (Number.isNaN(alertId)) {
            const errorMsg = 'Input alert-id must be a valid number';
            core.setFailed(errorMsg);
            throw new Error(errorMsg);
          }
          
          console.log(`Checking CodeQL alert #${alertId} on branch ${branchRef} in ${context.repo.owner}/${context.repo.repo}`);
          
          try {
            const response = await github.rest.codeScanning.getAlert({
              owner: context.repo.owner,
              repo: context.repo.repo,
              alert_number: alertId,
              ref: branchRef
            });
            
            const alert = response.data;
            const result = {
              exists: true,
              state: alert.state || 'unknown',
            };
            
            console.log(`Alert found: state=${result.state}, rule=${result.ruleId}, severity=${result.severity}`);
            
            return "true";

          } catch (error) {
            if (error.status === 404) {
              console.log(`Alert #${alertId} was not found on branch ${branchRef}.`);
              
              if (failOnMissing) {
                core.setFailed(`Alert #${alertId} not found and fail-on-missing is true.`);
                return "false";
              }
            } else {
              core.setFailed(`Failed to fetch alert #${alertId}: ${error.message}`);
                return "false";
            }
          }
    
    - name: Set composite action outputs
      shell: bash
      if: steps.check-alert.outcome == 'success'
      run: |
        echo "exists: ${{ steps.check-alert.outputs.result }}"
        echo 'exists=${{ steps.check-alert.outputs.result }}' >> $GITHUB_OUTPUT